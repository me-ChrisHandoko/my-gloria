'use client';

import { useAuth } from '@clerk/nextjs';
import { useEffect } from 'react';

/**
 * This provider ensures Clerk token is available for API calls
 */
export function AuthenticatedApiProvider({ children }: { children: React.ReactNode }) {
  const { getToken, isLoaded, isSignedIn } = useAuth();

  useEffect(() => {
    if (!isLoaded) return;

    // Set up a global function to get the token
    if (typeof window !== 'undefined') {
      (window as any).__getClerkToken = async (options?: { forceRefresh?: boolean }) => {
        if (!isSignedIn) {
          console.warn('User not signed in, cannot get token');
          return null;
        }
        
        try {
          // Pass skipCache option to force token refresh when needed
          const token = await getToken({ skipCache: options?.forceRefresh });
          if (token) {
            console.log('‚úÖ Token retrieved via AuthenticatedApiProvider' + (options?.forceRefresh ? ' (refreshed)' : ''));
            return token;
          } else {
            console.warn('‚ö†Ô∏è No token available from Clerk');
            return null;
          }
        } catch (error) {
          console.error('‚ùå Error getting token:', error);
          return null;
        }
      };
      
      console.log('üîê AuthenticatedApiProvider initialized');
    }
  }, [getToken, isLoaded, isSignedIn]);

  return <>{children}</>;
}